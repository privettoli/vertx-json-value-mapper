name: Release

on:
  push:
    tags:
    - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Get commit summary
      run: | 
        #TODO: find the previous tag somehow right here
        previousTag=$(git tag --sort=-creatordate | sed -n 2p)
        echo "previousTag : $previousTag"

        commitSummary="$(git log $previousTag..${{ github.ref }})"
        echo "::set-env name=COMMIT_SUMMARY::\"$commitSummary\""      
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Set up JDK 11
      uses: actions/setup-java@v1.4.1
      with:
        java-version: 11
    - name: Build with Gradle for Java 11
      run: ./gradlew build      
    - name: Create a Release
      uses: actions/create-release@v1.1.3
      with:
        tag_name: ${{ github.ref }}
        key: |
          release_name: Release ${{ github.ref }}
          body: ${{env.COMMIT_SUMMARY}}
          draft: false
          prerelease: false
    - name: Publish to Maven Central
      run: ./gradlew publish      
